name: Update homework countdowns

on:
  schedule:
    - cron: "0 0 * * *"   # runs daily
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update README countdowns
        run: |
          python << 'EOF'
          from datetime import datetime
          import re

          def days_left(date_str):
              target = datetime.strptime(date_str, "%d %B %Y %H:%M")
              now = datetime.utcnow()
              delta = (target - now).days
              if delta < 0:
                  return "‚ùå Deadline passed"
              elif delta == 0:
                  return "üî• Due today"
              else:
                  return f"‚è≥ {delta} days left"

          deadlines = {
              "HW1_COUNTDOWN": "27 January 2026 07:59",
              "HW2_COUNTDOWN": "3 February 2026 07:59",
              "HW3_COUNTDOWN": "10 February 2026 07:59",
              "HW4_COUNTDOWN": "17 February 2026 07:59",
              "HW5_COUNTDOWN": "1 March 2026 07:59",
              "WS1_COUNTDOWN": "3 March 2026 07:59",
              "HW6_COUNTDOWN": "10 March 2026 07:59",
              "HW7_COUNTDOWN": "17 March 2026 07:59",
          }

          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          for key, date in deadlines.items():
              pattern = rf"‚è≥.*?{{{{{key}}}}}.*?<!-- AUTO -->"
              new_line = f"‚è≥ {days_left(date)} {{{{{key}}}}}  <!-- AUTO -->"
              content = re.sub(pattern, new_line, content)

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(content)
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull --rebase
          git add README.md
          git commit -m "Auto-update countdowns" || exit 0
          git push


